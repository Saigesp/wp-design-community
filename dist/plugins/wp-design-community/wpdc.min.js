var Stream=require("stream").Stream,es=exports,through=require("through"),from=require("from"),duplex=require("duplexer"),map=require("map-stream"),pause=require("pause-stream"),split=require("split"),pipeline=require("stream-combiner"),immediately=global.setImmediate||process.nextTick;es.Stream=Stream,es.through=through,es.from=from,es.duplex=duplex,es.map=map,es.pause=pause,es.split=split,es.pipeline=es.connect=es.pipe=pipeline,es.concat=es.merge=function(){var e=[].slice.call(arguments);1===e.length&&e[0]instanceof Array&&(e=e[0]);var r=new Stream;r.setMaxListeners(0);var t=0;return r.writable=r.readable=!0,e.forEach(function(n){n.pipe(r,{end:!1});var i=!1;n.on("end",function(){i||(i=!0,t++,t==e.length&&r.emit("end"))})}),r.write=function(e){this.emit("data",e)},r.destroy=function(){e.forEach(function(e){e.destroy&&e.destroy()})},r},es.writeArray=function(e){if("function"!=typeof e)throw new Error("function writeArray (done): done must be function");var r=new Stream,t=[],n=!1;return r.write=function(e){t.push(e)},r.end=function(){n=!0,e(null,t)},r.writable=!0,r.readable=!1,r.destroy=function(){r.writable=r.readable=!1,n||e(new Error("destroyed before end"),t)},r},es.readArray=function(e){var r=new Stream,t=0,n=!1,i=!1;if(r.readable=!0,r.writable=!1,!Array.isArray(e))throw new Error("event-stream.read expects an array");return r.resume=function(){if(!i){n=!1;for(var a=e.length;a>t&&!n&&!i;)r.emit("data",e[t++]);t!=a||i||(i=!0,r.readable=!1,r.emit("end"))}},process.nextTick(r.resume),r.pause=function(){n=!0},r.destroy=function(){i=!0,r.emit("close")},r},es.readable=function(e,r){function t(u,c){u?(n.emit("error",u),r||n.emit("end")):arguments.length>1&&n.emit("data",c),immediately(function(){if(!(o||a||s))try{s=!0,e.call(n,i++,function(){s=!1,t.apply(null,arguments)})}catch(r){n.emit("error",r)}})}var n=new Stream,i=0,a=!1,o=!1,s=!1;if(n.readable=!0,n.writable=!1,"function"!=typeof e)throw new Error("event-stream.readable expects async function");return n.on("end",function(){o=!0}),n.resume=function(){a=!1,t()},process.nextTick(t),n.pause=function(){a=!0},n.destroy=function(){n.emit("end"),n.emit("close"),o=!0},n},es.mapSync=function(e){return es.through(function(r){var t=e(r);"undefined"!=typeof t&&this.emit("data",t)})},es.log=function(e){return es.through(function(r){[].slice.call(arguments);e?console.error(e,r):console.error(r),this.emit("data",r)})},es.child=function(e){return es.duplex(e.stdin,e.stdout)},es.parse=function(e){var r=!!(e?e.error:!1);return es.through(function(e){var t;try{e&&(t=JSON.parse(e.toString()))}catch(n){return r?this.emit("error",n):console.error(n,"attempting to parse:",e)}void 0!==t&&this.emit("data",t)})},es.stringify=function(){var e=require("buffer").Buffer;return es.mapSync(function(r){return JSON.stringify(e.isBuffer(r)?r.toString():r)+"\n"})},es.replace=function(e,r){return es.pipeline(es.split(e),es.join(r))},es.join=function(e){if("function"==typeof e)return es.wait(e);var r=!0;return es.through(function(t){return r||this.emit("data",e),r=!1,this.emit("data",t),!0})},es.wait=function(e){var r=[];return es.through(function(e){r.push(e)},function(){var t=Buffer.isBuffer(r[0])?Buffer.concat(r):r.join("");this.emit("data",t),this.emit("end"),e&&e(null,t)})},es.pipeable=function(){throw new Error("[EVENT-STREAM] es.pipeable is deprecated")};